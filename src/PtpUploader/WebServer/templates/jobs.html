{% extends "layout.html" %}

{% block head %}
  <title>PtpUploader - Jobs</title>
{% endblock %}

{% block body %}
  <table id="jobs" class="jobs rowborder compact" border="0" cellpadding="3" cellspacing="1">
    <thead>
      <tr>
        <th class="state"></th>
        <th>Release name</th>
        <th>Source</th>
        <th>Size</th>
        <th>Date</th>
        <th>Edit</th>
      </tr>
    </thead>

    <tbody>
      {% for entry in entries %}
        <tr>
          <td class="state">
	    <a href="{{ entry.LogPageUrl }}" {{ settings.OpenJobPageLinksInNewTab|safe }}><img src={{ entry.StateIcon }} title="{{ entry.State }}"></a>
          </td>
          <td class="name">
	    <span class="title">
	      {% if entry.PtpUrl %}
	        <a href="{{ entry.PtpUrl }}" {{ settings.OpenJobPageLinksInNewTab|safe }}>{{ entry.ReleaseName }}</a>
	      {% else %}
	        {{ entry.ReleaseName }}
	      {% endif %}
	    </span>

	    {% if entry.ErrorMessage %}
	      <br>
	      {{ entry.ErrorMessage }}
	    {% endif %}
          </td>
          <td class="nowrap">
	    {% if entry.SourceIcon %}
	      {% if entry.SourceUrl %}
	        <a href="{{ entry.SourceUrl }}" {{ settings.OpenJobPageLinksInNewTab|safe }}><img src={{ entry.SourceIcon }}></a>
	      {% else %}
	        <img src={{ entry.SourceIcon }}>
	      {% endif %}
	    {% endif %}
          </td>
          <td class="nowrap">
	    {{ entry.Size }}
          </td>
          <td class="nowrap">
	    {{ entry.Date }}
          </td>
          <td class="nowrap jobbuttons">
	    {% if entry.StartJobUrl %}
	      <a href="#" onclick='executeJobCommand( this, {{ entry.Id }}, "/start/" ); return false;'><img src={{ url_for( "static", filename = "start.png" ) }} title="Start"></a>
	    {% endif %}
	    {% if entry.StopJobUrl %}
	      <a href="#" onclick='executeJobCommand( this, {{ entry.Id }}, "/stop/" ); return false;'><img src={{ url_for( "static", filename = "stop.png" ) }} title="Stop"></a>
	    {% endif %}
	    {% if entry.EditJobUrl %}
	      <a href="{{ entry.EditJobUrl }}" {{ settings.OpenJobPageLinksInNewTab|safe }}><img src={{ url_for( "static", filename = "edit.png" ) }} title="Edit"></a>
	    {% endif %}
	    {% if entry.CanDeleteJob %}
	      <a href="#" class="delete_job_context_menu" PtpUploaderJobId='{{ entry.Id }}'><img src={{ url_for( "static", filename = "delete.png" ) }} title="Delete"></a>
	    {% endif %}
          </td>
        </tr>
    {% else %}
        <tr>
          <td>No entries.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <script type=text/javascript src="{{ url_for( "static", filename = "script/jquery-3.6.0.min.js" ) }}"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.contextMenu.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-contextmenu/2.7.1/jquery.ui.position.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">

  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>
  <script type="text/javascript">
   var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

   function ToggleSearch( searchToggler )
   {
     if ( !window.localStorage )
       return;

     if ( window.localStorage.getItem( 'HideSearch' ) == '1' )
     {
       $( ".ToggledByHideSearch" ).toggle( true );
       window.localStorage.removeItem( 'HideSearch' );
     }
     else
     {
       $( ".ToggledByHideSearch" ).toggle( false );
       window.localStorage.setItem( 'HideSearch', '1' );
     }
   }

   function executeJobCommand(linkNode, jobId, jobCommand)
   {
     $.ajax(
       {
         type: "GET",
         url: $SCRIPT_ROOT + "/job/" + jobId + jobCommand,
         context: linkNode,
         success: function(msg)
         {
	   $(this).text( msg );
	   if ( msg == "OK" )
	     $(this).fadeOut( "slow" );
         }
       } );
   }

   function executeDeleteJobCommand(linkNode, jobId, deleteMode)
   {
     $.ajax(
       {
         type: "GET",
         url: $SCRIPT_ROOT + "/job/" + jobId + '/delete/?mode=' + deleteMode,
         context: linkNode,
         success: function(msg)
         {
	   if ( msg == "OK" )
	     $( this ).parent().parent().fadeOut( "fast" );
	   else
	     $( this ).text( msg );
         }
       } );
   }


   $(document).ready( function () {
     $('#jobs').DataTable({
     });
     $.contextMenu( {
       selector: '.delete_job_context_menu',
       trigger: 'left',
       callback: function( key, options ) {
	 var deleteLink = options.$trigger;
	 var jobId = deleteLink.attr( 'PtpUploaderJobId' );
	 if ( jobId.length > 0 ) {
	   executeDeleteJobCommand( deleteLink, jobId, key );
	 }
       },
       items: {
	 "DeleteJob": { name: "Delete job" },
	 "DeleteJobAndSourceData": { name: "Delete job & source data" },
	 "DeleteJobAndUploadData": { name: "Delete job & upload data" },
	 "DeleteJobAndAllData": { name: "Delete job & all data" },
       }
     } );
   } );
  </script>
{% endblock %}
